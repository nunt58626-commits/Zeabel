<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<title>ประวัติการเคลื่อนย้ายสินค้า</title>
<script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body style="background-color: rgba(185, 195, 255, 0.64);">
<nav class="navbar navbar-dark fixed-top" style="background-color: #292755;">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">ประวัติสินค้า ST1</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar">
      <div class="offcanvas-header" style="background-color: rgba(185, 195, 255, 0.64);">
        <h5 class="offcanvas-title">เมนู</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body" style="background-color: #292755;">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="index.html">บันทึกสินค้า</a></li>
          <li class="nav-item"><a class="nav-link active" href="save.html">ประวัติสินค้า</a></li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<div class="container mt-5 pt-4">
  <div class="d-flex justify-content-end mb-3">
    <button onclick="exportExcel()" class="btn btn-warning me-2">ส่งออก Excel</button>
    <button class="btn btn-danger" onclick="clearHistory()">ล้างประวัติ</button>
  </div>
  <div id="historyTableContainer"></div>
</div>

<script>
let stockData = JSON.parse(localStorage.getItem('stockMovements')) || [];

function renderTable(data) {
  const container = document.getElementById('historyTableContainer');
  if (!data.length) {
    container.innerHTML = '<p class="text-center mt-3">ยังไม่มีประวัติ</p>';
    return;
  }

  let html = `
    <div class="table-responsive">
      <input type="text" id="searchInput" class="form-control mb-2" placeholder="ค้นหารหัสสินค้า">
      <table class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr>
            <th>รหัสสินค้า</th>
            <th>จำนวนลัง</th>
            <th>จากตำแหน่ง</th>
            <th>ไปตำแหน่ง</th>
            <th>วันผลิต</th>
            <th>วันหมดอายุ</th>
            <th>เวลาบันทึก</th>
          </tr>
        </thead>
        <tbody id="historyTableBody">
  `;

  data.forEach(item => {
    html += `<tr>
      <td>${item.productCode}</td>
      <td>${item.quantity}</td>
      <td>${item.locationFrom}</td>
      <td>${item.locationTo}</td>
      <td>${item.mfgDate}</td>
      <td>${item.expDate}</td>
      <td>${new Date(item.timestamp).toLocaleString()}</td>
    </tr>`;
  });

  html += '</tbody></table></div>';
  container.innerHTML = html;

  document.getElementById('searchInput').addEventListener('input', function() {
    const filter = this.value.toLowerCase();
    document.querySelectorAll('#historyTableBody tr').forEach(row => {
      row.style.display = row.cells[0].textContent.toLowerCase().includes(filter) ? '' : 'none';
    });
  });
}

function clearHistory() {
  if (confirm('คุณแน่ใจที่จะล้างประวัติทั้งหมด?')) {
    stockData = [];
    localStorage.removeItem('stockMovements');
    renderTable(stockData);
    alert('ล้างประวัติเรียบร้อยแล้ว');
  }
}

function exportExcel() {
  if (!stockData.length) {
    alert('ไม่มีข้อมูลให้ส่งออก');
    return;
  }

  let csvContent = '\uFEFF';
  csvContent += "รหัสสินค้า,จำนวนลัง,จากตำแหน่ง,ไปตำแหน่ง,วันผลิต,วันหมดอายุ,เวลาบันทึก\n";

  stockData.forEach(item => {
    const row = [
      item.productCode,
      item.quantity,
      item.locationFrom,
      item.locationTo,
      item.mfgDate,
      item.expDate,
      new Date(item.timestamp).toLocaleString()
    ].join(",");
    csvContent += row + "\n";
  });

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "stock_history.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

document.addEventListener('DOMContentLoaded', () => renderTable(stockData));
</script>
</body>
</html>
